<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Rails Active Record Cheat Sheet</title>
  <meta name="description" content="Preamble: Sometimes, the hardest part is to be aware an ideal method exists for your purposes.">

  <link rel="stylesheet" href="/main.css"  type="text/css">
  <link rel="icon" sizes="32x32" href="/assets/favicon.png">

  <link rel="canonical" href="https://natachasegala.co.uk/reading-notes/active-record-cheat-sheet/">
  <link rel="alternate" type="application/rss+xml" title="/^1 pat{2}ern 2 hap{2}ines{2}.*/" href="https://natachasegala.co.uk/feed.xml">
</head>

<header>
  <nav class="nav-header">
    <button tabindex="0" type="button" class="nav-menu-button">
      <svg viewBox="0 0 24 24" class="nav-menu-button-icon">
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z">
        </path>
      </svg>
    </button>
    <div class="nav-site-title">
      <a class="unstyledLink xlHeader" href="/">
        /^1 pat{2}ern 2 hap{2}ines{2}.*/
      </a>
    </div>

    <div class="nav-about-container" >
      <a href="/about" class="unstyledLink nav-header-icon">

        <svg viewBox="0 0 24 24" class="nav-menu-button-icon nav-secondary-icon" >
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z">
          </path>
        </svg>
      </a>
    </div>
  </nav>
</header>


<body>
<div id="root"></div>

<div class="page-content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
            <h1 class="post-title" itemprop="name headline">Rails Active Record Cheat Sheet</h1>
            <p class="post-meta"><time datetime="2017-07-09T00:00:00+01:00" itemprop="datePublished">Jul 9, 2017</time></p>
        </header>

        <div class="post-content" itemprop="articleBody">
            <p>Preamble: Sometimes, the hardest part is to be aware an ideal method exists for your purposes.</p>

<p>Notes created based on the <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a></p>

<p>Active Record Query interface is an alternative to using raw SQL in order to retrieve records from your database.</p>

<p>Each will:</p>

<ol>
  <li>convert options to equivalent SQL query</li>
  <li>use SQL</li>
  <li>retrieve results</li>
  <li>convert results to the equivalent ruby object of the appropriate model for every row</li>
  <li>run after_find then after_initialize callbacks if relevant</li>
</ol>

<p>List of methods:</p>

<table>
  <thead>
    <tr>
      <th>structure</th>
      <th>what to know</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">.find(id || [ids])</code></td>
      <td>raises an ActiveRecord::RecordNotFound error in case of no record</td>
    </tr>
  </tbody>
</table>

<p>All methods below:</p>
<ul>
  <li>do not raise exceptions</li>
  <li>if followed by ‘!’, raise an exception</li>
</ul>

<table>
  <thead>
    <tr>
      <th>structure</th>
      <th>what to know</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">.take(optional n)</code></td>
      <td>picks one (or n) ‘random’ record from table, returns nil/no exception in case of no record</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">.first(optional n) / .last(optional n)</code></td>
      <td>returns first/last (n) record(s) <br />default -&gt; ordered by primary key <br />with <code class="highlighter-rouge">.order(:attribute)</code> -&gt; ordered by specified attribute <br />with <code class="highlighter-rouge">default_scope</code> on model -&gt; ordered by scope on model</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">.find_by</code></td>
      <td>returns record based on attribute search.<br /> Bonus: can be written <code class="highlighter-rouge">.find_by_some_attribute_name</code></td>
    </tr>
  </tbody>
</table>

<p>To perform big queries:</p>

<p><code class="highlighter-rouge">Table.all</code> is very expensive:</p>

<ol>
  <li>fetch the table in a single pass</li>
  <li>build a model object per row</li>
  <li>keep the entire array of model object in memory (depending on the number of records might exceed memory)</li>
</ol>

<p>2 memory-friendly methods:</p>
<ul>
  <li>works on model classes and on relations</li>
</ul>

<p>Options:</p>

<ul>
  <li><code class="highlighter-rouge">:batch_size</code></li>
  <li><code class="highlighter-rouge">:start</code> (which primary key to start from - inclusive)</li>
  <li><code class="highlighter-rouge">:finish</code> (which primary key to finish with - exclusive)</li>
</ul>

<table>
  <thead>
    <tr>
      <th>structure</th>
      <th>what to know</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">.find_each</code></td>
      <td>1. retrieve records in batches<br />2. yields each one to the block <br /> NB:<br />If an order is present, the behaviour depends on the flag <code class="highlighter-rouge">config.active_record.error_on_ignored_order</code>.<br />If <code class="highlighter-rouge">true</code>, <code class="highlighter-rouge">ArgumentError</code> is raised.<br />By default, the order is ignored and a warning issued.<br />This warning can be overridden with the option <code class="highlighter-rouge">:error_on_ignore</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">.find_in_batches</code></td>
      <td>1. retrieve records in batches<br />yields batches to the block as an array of models</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="conditions">CONDITIONS</h3>

<table>
  <thead>
    <tr>
      <th>structure</th>
      <th>what to know</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">.where</code><br /><br /><code class="highlighter-rouge">.where("attribute = ? AND other_attribute= ?", params[:param], params[:other_param])</code><br /><br /><code class="highlighter-rouge">.where("attribute &gt;= :attribute AND other_attribute &lt;= :other_attribute",{attribute: params[:attribute], other_attribute: params[:other_attribute]})</code></td>
      <td>conditions can be string, array or hash<br />Do not use with pure strings =&gt; SQL injection</td>
    </tr>
  </tbody>
</table>

<h4 id="equality">Equality:</h4>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">(attribute: some_value)</code></td>
      <td> </td>
      <td><code class="highlighter-rouge">('attribute' =&gt; some_value)</code></td>
    </tr>
  </tbody>
</table>

<p>Belongs_to or polymorphic associations can be used:
<code class="highlighter-rouge">Table.where(attribute: some_record)</code>
<code class="highlighter-rouge">Table.joins(:attribute).where(some_attributes: { other_attribute: record })</code></p>

<h4 id="range">Range:</h4>

<p><code class="highlighter-rouge">Table.where(attribute: some_range_start..some_range_end)</code></p>

<h4 id="subset">Subset:</h4>
<p><code class="highlighter-rouge">Table.where(attribute: [somearray])</code></p>

<h4 id="not">Not:</h4>
<p><code class="highlighter-rouge">Table.where.not(somecondition)</code></p>

<h3 id="ordering">ORDERING</h3>
<p><code class="highlighter-rouge">.order(:attribute)</code>
<code class="highlighter-rouge">.order(attribute: :desc) or .order(attribute: :asc)</code>
<code class="highlighter-rouge">.order(attribute: :asc, other_attribute: :desc)</code>
etc.</p>

<p>if using MySQL 5.7.5 and above, on selecting fields from a result set using methods like select, pluck and ids, order method raises ActiveRecord::StatementInvalid  unless the field(s) used in order clause are included in the select list.</p>

<h3 id="selecting">SELECTING</h3>

<p><code class="highlighter-rouge">.select('attribute, other_attribute')</code></p>

<p>initialises a model object with only these fields
all other fields from the original model do not exist =&gt; <code class="highlighter-rouge">ActiveModel::MissingAttributeError: missing attribute: &lt;attribute&gt;</code></p>

<p><code class="highlighter-rouge">.select(:attribute).distinct</code></p>

<p>returns a single record per unique value in a certain field</p>

<p><code class="highlighter-rouge">.select(:attribute).distinct.distinct(false)</code></p>

<p>toggles the constraint</p>

<h3 id="limitingoffsetting">LIMITING/OFFSETTING:</h3>

<p><code class="highlighter-rouge">.limit(number)</code></p>

<p>returns limit of records (starting from first by default)</p>

<p><code class="highlighter-rouge">.offset(number)</code></p>

<p>starts record retrieval from number</p>

        </div>

    </article>
</div>

<footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>/^1 pat{2}ern 2 hap{2}ines{2}.*/</li>
          <li><a href="mailto:natseg@gmail.com">natseg@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/natseg"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">natseg</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Get to know me a little bit better. Javascript using React and Typescript, Ruby using Rails, Elixir with Phoenix. Programming and learning in a broader sense.
</p>
      </div>
    </div>

  </div>

</footer>

<script type="text/javascript" src="/default.entry.js" charset="utf-8"></script>
</body>

</html>
